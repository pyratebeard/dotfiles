#!/usr/bin/env zsh

# vars
WIFI_DEV="wlp3s0"
CONNECTION_FILE_PATH="$HOME/lib/doc/wifi/"
CONNECTION_FILE=$CONNECTION_FILE_PATH$1
CONNECTION=$(echo ${CONNECTION_FILE} | awk -F\/ '{print $NF}')

if [ ! $1 ] ; then
	echo "specify a connection file"
	exit 1
elif [ ! -f ${CONNECTION_FILE} ] ; then
	echo "${CONNECTION_FILE} does not exist"
	exit 1
fi

# disconnect
echo "disconnecting any running connection"
$HOME/bin/disconnect

# bring dev up
if $(ip link show up | grep ${WIFI_DEV} >/dev/null) ; then
	echo "${WIFI_DEV} is already up"
else
	echo "bringing ${WIFI_DEV} up"
	sudo ip link set ${WIFI_DEV} up >/dev/null
fi

# connect using specified config
if [ -f ${CONNECTION_FILE} ] ; then
	echo "connecting to ${CONNECTION}"
	sudo wpa_supplicant -B -q -i ${WIFI_DEV} -c ${CONNECTION_FILE} >/dev/null 2>&1
fi

# get an ip
echo "starting dhcpcd"
sudo dhcpcd -b -4 ${WIFI_DEV} >/dev/null 2>&1

function use_vpn() {
	echo "not at home, starting vpn"
	sleep 20
	sudo openvpn --config lib/key/wht-rht-obj.ovpn --daemon >/dev/null 2>&1
	sudo systemd-tty-ask-password-agent
	echo "waiting for vpn..."
	sleep 60
	sudo cp $HOME/tmp/opendns /etc/resolv.conf
	sudo ip route add 192.168.0.0/24 via 10.8.0.13 dev tun0
	while :
	ping -q -c1 fortkickass >/dev/null
	if [ $? -eq 0 ] ; then
		echo "vpn is up"
		break
	else
		echo "still waiting..."
		sleep 2
	fi	
}
# when remote bring ip vpn
case "${CONNECTION}" in
	home) ;; #|artoo) ;;
	*) use_vpn ;;
esac

