#!/usr/bin/env bash

# vars
WIFI_DEV="wlp3s0"
CONNECTION_FILE=$1
CONNECTION=$(echo ${CONNECTION_FILE} | awk -F\/ '{print $NF}')

if [ ! $1 ] ; then
	echo "specify a connection file"
	exit 1
elif [ ! -f ${CONNECTION_FILE} ] ; then
	echo "${CONNECTION_FILE} does not exist"
	exit 1
fi

# disconnect
echo "disconnecting any running connection"
$HOME/bin/disconnect

# bring dev up
if $(ip link show up | grep ${WIFI_DEV} >/dev/null) ; then
	echo "${WIFI_DEV} is already up"
else
	echo "bringing ${WIFI_DEV} up"
	sudo ip link set ${WIFI_DEV} up >/dev/null
fi

# connect using specified config
if [ -f ${CONNECTION_FILE} ] ; then
	echo "connecting to ${CONNECTION}"
	sudo wpa_supplicant -B -q -i ${WIFI_DEV} -c ${CONNECTION_FILE} >/dev/null 2>&1
fi

# get an ip
echo "starting dhcpcd"
sudo dhcpcd ${WIFI_DEV} >/dev/null 2>&1

# when remote bring ip vpn
if [ ${CONNECTION} != "home" ] ; then
	echo "not at home, starting vpn"
	sudo openvpn --config lib/key/wht-rht-obj.ovpn --daemon >/dev/null 2>&1
	sudo systemd-tty-ask-password-agent >/dev/null
	sleep 5
	ping -q -c1 fortkickass >/dev/null
	if [ $? -eq 0 ] ; then
		echo "vpn is up"
	else
		echo "vpn is not up... disconnecting now"
		$HOME/bin/disconnect
	fi	
fi
